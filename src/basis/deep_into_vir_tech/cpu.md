# CPU 虚拟化

## 指令的模拟

VMM 运行在最高特权级，可以控制物理处理器上的所有关键资源；而客户机操作系统运行在非最高特权级，所以其敏感指令会陷入到 VMM 中通过软件的方式进行模拟。

- 虚拟寄存器

    当 VMM 接管物理处理器之后，昔日的操作系统就成为了客户机操作系统而降级到非最高特权级别上，这时，其试图访问关键资源的指令就成了敏感指令。VMM 会通过各种手段，保证客户机在执行这些敏感指令能够触发异常，从而陷入到 VMM 进行模拟，以防止对 VMM 自身的运行造成破坏。当客户机试图访问关键资源的时候，该请求并不会真正的发生在物理寄存器上，相反，VMM 会通过准确模拟物理处理器的行为，将其访问定位到 VMM 为其设计的与物理寄存器对应的虚拟寄存器上。这样的虚拟寄存器往往是在物理内存中实现的。下图是虚拟机访问 CR0 寄存器的一个示例：

![](/images/basis/virtual_register.png)

- 虚拟机进程上下文

    对于虚拟处理器，其上下文包括了更多的系统寄存器，因此此时虚拟机进程的上下文也就更复杂。

- 虚拟处理器

    VMM 能够模拟虚拟机的前提是能够陷入，客户机执行系统操作时，通知 VMM 的功能是利用了处理器的保护机制，利用中断和异常来完成的，具体来说有一下几种方式：

1. 基于处理器保护机制触发的异常。

2. 虚拟机主动触发异常，也就是通常所说的陷阱。

3. 异步中断，包括处理器内部的中断源和外部设备的中断源。

## 中断和异常的模拟及注入


## 对称多处理器技术的模拟

