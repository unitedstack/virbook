### 概述

在没有虚拟化的情形下，由于处理器处于计算机的核心位置，因此外设的访问接口最终也会被映射到处理器所能认识的地址空间或者其他资源中。这样，当设备驱动程序通过指令的方式访问外设几口时，处理器才能正确识别目标对象，然后将相关请求发送到系统总线上，最终由芯片组转发给目标外设。下图是一个典型设备可能会具有的资源：

![](/images/basis/io_device_resource.png)

1. I/O 端口寄存器

2. MMIO 寄存器

3. 中断

### 设备发现

设备发现就是要让 VMM 提供一种方式，来让客户机操作系统发现虚拟设备，这样客户机操作系统才能加载相关的驱动程序，这是 I/O 虚拟化的第一步。

### 访问截获

当虚拟设备被客户机操作系统发现时，客户机操作系统中的驱动程序就会按照接口定义的访问这个虚拟设备。这里的关键点就在于处理器的虚拟化。

具体参见参考资料。

### 设备模拟

下表是 I/O 虚拟化的一个总结：

| I/O 虚拟化方式 | 兼容性 | 性能 | 成本 | 扩展性|
|----------------|--------|------|------|-------|
|设备接口完全模拟|重用已有的驱动程序|纯碎的软件模拟引起的太多的上下文切换|没有额外的硬件开销|设备模拟器一端是瓶颈|
|PE/BE 完全模拟|需要加载特定的驱动程序|基于失误的通信机制简化了PE/BE 之间的开销|没有额外的硬件开销|BE一段是瓶颈|
|直接分配之 VT-d|重用已有的驱动程序|直接访问物理设备，减少了虚拟化的开销|需要购买较多额外的硬件|有局限性，例如主板上的扩展槽一般是有限的|
|直接分配值 SR-IOV|需要加载新的驱动程序|直接访问物理资源，减少了虚拟化的开销|需要购买较少的额外物理硬件|扩展性较好，因为 SR-IOV 设备本身支持多个虚拟机同时访问|

### 设备共享

敬请期待...

### 参考资料

敬请期待...
