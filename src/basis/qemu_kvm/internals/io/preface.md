### 前言

QEMU/KVM 是一套完整的半虚拟化解决方案。其中 Linux 的内核模块 KVM 借助于物理 CPU 提供的虚拟化功能，使得虚拟机能够直接的访问宿主机的 CPU 以及内存，实现高效的 CPU 及内存的虚拟化。

但是，在 I/O 虚拟化方面，最初是利用 QEMU 提供的设备模拟功能来进行虚拟化，例如 QEMU 可以模拟出各种各样的网卡，供虚拟机使用。此时，虚拟机并不知道自己是处于虚拟化环境中，于是虚拟机将这些 QEMU 模拟出来的设备当做真实的物理设备来进行驱动、读写。Hypervisor 捕获虚拟机的 I/O 请求，将 I/O 操作做进一步转换，然后利用宿主机上的物理硬件来完成相应的请求，最后把结果返回给虚拟机。

由于，在全虚拟化 I/O 的情况下，一次 I/O 请求在 guest -&gt; hypervisor -&gt; host 这个流程中，上下文转换次数非常多，从而效率低下。于是就出现 virtio I/O 驱动接口（框架）。它主要的作用是让虚拟机知道自己处于虚拟化环境中，让虚拟机通过特定的数据交换方式，高效地与物理 I/O 硬件交互，从而实现 I/O 的半虚拟化。

在某些特殊情况下，可能还会将宿主机的 PCI 设备直接交由虚拟机使用，于是出现了 PCI 透传技术。该技术是将宿主机上某物理设备（如网卡、 usb 设备）直接附加至虚拟机中，虚拟机直接驱动并操作该物理设备。

但是，PCI 透传技术也存在一定的局限性：当宿主机上有多台虚拟机，并且它们都需要专用的物理 PCI 设备，我们知道 PCI 插槽是有限的，这时仅仅利用 PCI 透传就不能满足需求。于是 SR-IOV 技术应运而生，该技术是将一个物理 PCI 设备虚拟（抽象成 Physical Function， PF ）虚拟成多个功能与物理设备相近的虚拟设备 \(Virtual Function， VF\)，然后透传技术将这些 VF 直接附加到虚拟机中。不过前提条件是这些宿主机上的物理 PCI 设备必须支持 SR-IOV功能。

本节依次介绍 virtio驱动、PCI 透传及 SR-IOV 技术。

