# QEMU/KVM 快照

将虚拟机在某个时间点的磁盘，内存和设备状态保存下来，以供将来可以随时回滚到打快照时的时间点。

##虚拟机快照可以有如下用途

- 在环境刚搭建完成时，保存“纯净”的系统，包括所安装的软件设置。
- 在做不确定操作，可能会导致虚拟机崩溃时，提前打快照作为备份文件，出现问题随时恢复。

## QEMU/KVM快照分类

### 一、磁盘快照

磁盘的内容（可能是磁盘内容的一部分或者是整块磁盘）在某个时间点被保存，然后可以被恢复。
对于一个处于active状态的客户机，磁盘快照很可能是崩溃一致的，而不是完整一致的。也就是说，它表示的是在客户机突然掉电的那一刻时的磁盘状态。在机器重启后，可能需要通过fsck或者别的方式恢复到完整一致的状态。
对于一个处于inactive状态的客户机，若客户机在最后一次被关机时磁盘是完整一致的，则磁盘快照也是完整一致。

磁盘快照又分为以下两种形式：
- **内部快照**

	内部快照是qcow2中的snapshot table所维护的snapshot，所有的snapshot都是在同一个qcow2文件中维护。这种快照是libvirt的默认行为，现在的支持很完善（创建、回滚和删除），但是只能针对qcow2格式的磁盘镜像文件，而且其过程较慢等。
- **外部快照**

	外部快照是一个只读文件，快照之后的修改会生成另一个文件。这种快照可以支持各种格式的磁盘镜像文件。外置快照的结果是形成一个 qcow2 文件链：original <- snap1 <- snap2 <- snap3。

### 二、内存快照（虚拟机快照）

这种类型的快照只跟踪虚拟机的RAM和其他资源。如果在执行了内存快照，然后再恢复，这两个操作之间没有为对磁盘进行操作，则客户机恢复后磁盘是完整一致的。若在此期间磁盘被外部操作或应用程序所修改，这将很可能导致数据被毁坏。


### 三、检查点快照

磁盘快照和内存快照的组合，可用于恢复完整的系统状态（类似于系统休眠）。

libvirt提供了多种接口，可以管理以上三种类型的快照。本章下面各节将详细对以上三种类型的快照作介绍。


## 参考文档

1. Snapshot XML format：http://libvirt.org/formatsnapshot.html
2. 使用libvirt做QEMU/KVM快照和Nova实例的快照：http://www.cnblogs.com/sammyliu/p/4468757.html